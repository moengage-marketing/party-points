<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scan QR - Party Points</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #ee371b; color: white; text-align:center; }
    header img { max-height: 50px; }
  </style>
</head>
<body>
<header class="p-2 d-flex justify-content-between align-items-center">
    <img src="images/growth_logo.png" alt="GROWTH">
    <img src="images/moengage_logo.png" alt="MoEngage">
</header>
<main class="container mt-4">
    <h2>Scan QR Code</h2>
    <div id="reader" style="width:300px;margin:auto;"></div>
    <div id="result" class="mt-3"></div>
</main>

<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA7vlr3u00U90cgveeevHG1ql-KRO-lVGs",
  authDomain: "party-points-59775.firebaseapp.com",
  projectId: "party-points-59775",
  storageBucket: "party-points-59775.appspot.com",
  messagingSenderId: "243749681140",
  appId: "1:243749681140:web:cf772f44290b02c321aba1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function getPartyLevel(points) {
    if (points <= 50) return "New to the Party ðŸ¹";
    if (points <= 100) return "Social Starter ðŸŽ¶";
    if (points <= 200) return "Rockstar ðŸŽ¸";
    if (points <= 300) return "VIP Guest ðŸ¥‚";
    if (points <= 500) return "Party Animal ðŸŽ‰";
    return "Life of the Party ðŸª©";
}

auth.onAuthStateChanged(user => {
  if (!user) {
    document.getElementById('result').textContent = "Please sign in first!";
    return;
  }

  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" }, 
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      const urlParams = new URL(qrCodeMessage).searchParams;
      const actionId = urlParams.get('id');
      if (!actionId) {
        document.getElementById('result').textContent = "QR code invalid.";
        return;
      }
      
      // Award points from Firestore pointsConfig
      db.collection('pointsConfig').doc(actionId).get().then(doc => {
        if (!doc.exists) {
          document.getElementById('result').textContent = "Unknown action.";
          return;
        }
        const pointsToAdd = doc.data().points;
        const userRef = db.collection('users').doc(user.uid);
        userRef.get().then(userDoc => {
          const currentPoints = userDoc.data().points || 0;
          const newPoints = currentPoints + pointsToAdd;
          userRef.update({ points: newPoints }).then(() => {
            document.getElementById('result').innerHTML = 
              `<p>âœ… ${pointsToAdd} points added!</p>
               <p>Total: ${newPoints} points</p>
               <p>Level: ${getPartyLevel(newPoints)}</p>`;
          });
        });
      });

      html5QrCode.stop();
    },
    errorMessage => { /* ignore read errors */ }
  );
});
</script>
</body>
</html>
